<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pictures to PDF Generator</title>
<link rel="icon" href="https://raw.githubusercontent.com/pgarciafer/pics2PDF/main/logo1.png" type="image/png">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
:root {
  --primary-blue: #0069d9;
  --dark-blue: #004c99;
  --light-gray: #f8f9fa;
  --medium-gray: #e9ecef;
  --dark-text: #343a40;
  --red-error: #dc3545;
}

body {
  font-family: 'Poppins', sans-serif;
  background-color: var(--light-gray);
  margin: 0;
  padding: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
}

.container {
  max-width: 700px;
  width: 95%;
  margin: 10px;
  padding: 15px;
  background: #ffffff;
  border-radius: 12px;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
}

.header-container {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  border-bottom: 3px solid var(--medium-gray);
  padding-bottom: 20px;
}

.header-title {
  display: flex;
  align-items: center;
}

.header-title img {
  height: 80px;
  margin-right: 20px;
}

.header-title span {
  color: var(--dark-text);
  font-size: 24px;
  font-weight: 600;
}

.contact-btn {
  padding: 8px 12px;
  background-color: var(--primary-blue);
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  text-decoration: none;
  transition: background-color 0.3s;
}

.contact-btn:hover {
  background-color: var(--dark-blue);
}

label {
  display: block;
  margin-top: 10px;
  font-weight: 600;
  color: var(--dark-text);
  font-size: 13px;
  cursor: pointer;
}

input, select, textarea {
  width: 100%;
  padding: 8px;
  margin-top: 5px;
  border-radius: 6px;
  border: 1px solid var(--medium-gray);
  font-size: 13px;
  box-sizing: border-box;
  transition: border-color 0.3s, box-shadow 0.3s;
}

input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: var(--primary-blue);
  box-shadow: 0 0 0 2px rgba(0, 105, 217, 0.25);
}

input[type="file"] {
  padding: 8px;
}

/* Consistent drop zone layout for pictures and attachments */
.drop-zone-section {
  display: flex;
  align-items: stretch;
  gap: 15px;
  margin-bottom: 15px;
}

.drop-zone {
  flex: 1;
  width: 200px;        /* Fixed width, same as remove button */
  height: 100px;       /* Same height as remove button */
  border: 3px dashed var(--primary-blue);
  background: #e6f0ff;
  padding: 20px;
  text-align: center;
  cursor: pointer;
  border-radius: 8px;
  transition: background 0.3s, border-color 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.drop-zone:hover {
  background: #cce0ff;
  border-color: var(--dark-blue);
}

.drop-zone p {
  font-size: 14px;
  color: var(--dark-blue);
  margin: 0;
}

.image-list-container {
  border: 1px solid var(--medium-gray);
  min-height: 100px;
  max-height: 150px;
  overflow-y: auto;
  padding: 10px;
  margin-bottom: 15px;
  border-radius: 6px;
  background: #fafafa;
  display: none;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: flex-start;
}

.image-wrapper {
  position: relative;
  display: inline-block;
}

.image-item {
  width: 50px;
  height: 50px;
  object-fit: contain;
  border: 1px solid var(--medium-gray);
  border-radius: 6px;
  padding: 5px;
  background: #fff;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  cursor: grab;
}

.image-item.dragging {
  opacity: 0.5;
}

.remove-image-btn {
  position: absolute;
  top: -6px;
  right: -6px;
  background: rgba(0, 0, 0, 0.6);
  color: white;
  border: none;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  font-size: 14px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  opacity: 0.8;
  transition: opacity 0.3s, background-color 0.3s;
}

.remove-image-btn:hover {
  opacity: 1;
  background: rgba(0, 0, 0, 0.85);
}

.attachment-section {
  margin-top: 30px;
}

.attachment-list-container {
  border: 1px solid var(--medium-gray);
  min-height: 50px;
  max-height: 100px;
  overflow-y: auto;
  padding: 10px;
  margin-bottom: 15px;
  border-radius: 6px;
  background: #fafafa;
  display: none;
}

.attachment-item {
  font-size: 12px;
  color: var(--dark-text);
  padding: 5px 0;
  border-bottom: 1px solid var(--medium-gray);
}

.attachment-item:last-child {
  border-bottom: none;
}

.button-group {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 15px;
}

button {
  flex: 1;
  padding: 10px 15px;
  background-color: var(--primary-blue);
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  transition: background-color 0.3s, transform 0.1s;
}

button:hover {
  background-color: var(--dark-blue);
  transform: translateY(-1px);
}

button:disabled {
  background-color: #ced4da;
  cursor: not-allowed;
}

/* Green Job Info Button */
.job-info-btn {
  background-color: #28a745;
  margin-bottom: 20px;
}

.job-info-btn:hover {
  background-color: #218838;
}

.required-label {
  color: var(--red-error);
}

.invalid {
  border: 2px solid var(--red-error) !important;
}

.status-message {
  text-align: center;
  margin-top: 10px;
  font-size: 12px;
  color: var(--dark-text);
}

/* Red "Remove All" buttons */
button.remove-btn {
  background-color: #ff4d4d;
  color: white;
  flex: none;
  width: 200px; /* ‚úÖ fixed width to match attachments button */
  height: 100px; /* ‚úÖ fixed height */
  align-self: stretch;
  padding: 0 10px;
  font-weight: bold;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: background-color 0.3s;
    display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
}

button.remove-btn:hover {
  background-color: #cc0000;
}

button.remove-btn:disabled {
  background-color: #e0e0e0;
  color: #888;
  cursor: not-allowed;
}

/* Responsive */
@media (max-width: 600px) {
  .container {
    padding: 15px;
    margin: 10px;
  }

  .header-container {
    flex-direction: column;
    align-items: center;
  }

  .header-title {
    flex-direction: column;
    margin-bottom: 10px;
  }

  .contact-btn {
    width: 100%;
    text-align: center;
  }

  .button-group button {
    flex: 1 1 100%;
  }

  .drop-zone-section {
    flex-direction: column;
  }

  button.remove-btn {
    width: 100%;
    height: auto;
  }
}

</style>
</head>
<body>
<div class="container">
<div class="header-container">
  <div class="header-title">
    <a href="https://www.mtnsat.com" target="_blank">
      <img src="https://raw.githubusercontent.com/pgarciafer/pics2PDF/main/logo.png" alt="Logo">
    </a>
    <span>Pictures Array to PDF</span>
  </div>
  <a href="contact.html" class="contact-btn">Contact</a>
</div>

<div class="job-info-container">
  <button id="jobInfoLabel" class="job-info-btn">Load/Update Current Job Info (.txt)</button>
</div>

<div class="drop-zone-section">
  <div class="drop-zone" id="dropZone">
    <p>üìÅ Pictures here</p>
  </div>
  <button id="removeAllBtn" class="remove-btn">Remove All Images</button>
</div>
<div class="image-list-container" id="imageListContainer"></div>


<div class="attachment-section">
  <div class="drop-zone-section">
    <div class="drop-zone" id="attachmentsDropZone">
      <p>üìé Attachments Here</p>
    </div>
    <button id="removeAllAttachmentsBtn" class="remove-btn">Remove All Attachments</button>
  </div>
  <div class="attachment-list-container" id="attachmentListContainer"></div>
</div>

<label for="vesselName">3LC_VesselName: <span class="required-label">*</span></label>
<input type="text" id="vesselName" placeholder="e.g., NCL_RoyalClipper">

<label for="antennaModel">AntennaBrandModel_SNxxx: <span class="required-label">*</span></label>
<input type="text" id="antennaModel" placeholder="e.g., Intellian-v100_SN24536">

<label for="antennaLocation">Antenna Location: <span class="required-label">*</span></label>
<input type="text" id="antennaLocation" placeholder="e.g., Deck 1 Starboard">

<label for="caseNumber">Case Number: <span class="required-label">*</span></label>
<input type="tel" id="caseNumber" inputmode="numeric" pattern="[0-9]*" placeholder="e.g., 35234">

<label for="submittedBy">Submitted By: <span class="required-label">*</span></label>
<input type="text" id="submittedBy" placeholder="e.g., Pablo Garcia">

<label for="dateField">Date: <span class="required-label">*</span></label>
<input type="date" id="dateField">

<label for="imagesPerPage">Images per page (1-4):</label>
<select id="imagesPerPage">
  <option value="1">1</option>
  <option value="2" selected>2</option>
  <option value="3">3</option>
  <option value="4">4</option>
</select>

<div class="button-group">
  <button id="generatePDF">Generate PDF & ZIP</button>
</div>

<div class="status-message" id="statusMessage"></div>
</div>
<script>
const { jsPDF } = window.jspdf;
let images = [];
let attachments = [];
const dropZone = document.getElementById('dropZone');
const imageListContainer = document.getElementById('imageListContainer');
const attachmentsDropZone = document.getElementById('attachmentsDropZone');
const attachmentListContainer = document.getElementById('attachmentListContainer');
const generateBtn = document.getElementById('generatePDF');
const statusMessage = document.getElementById('statusMessage');

// Default date
document.getElementById("dateField").value = new Date().toISOString().split("T")[0];

// === Helpers ===
async function fileToJpegDataURL(file, maxDim = 2000, quality = 0.7) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = () => {
        const scale = Math.min(maxDim / img.width, maxDim / img.height, 1);
        const canvas = document.createElement("canvas");
        canvas.width = img.width * scale;
        canvas.height = img.height * scale;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        canvas.toBlob(blob => {
          if (!blob) return reject("Canvas conversion failed");
          const fr = new FileReader();
          fr.onload = () => resolve(fr.result);
          fr.readAsDataURL(blob);
        }, "image/jpeg", quality);
      };
      img.onerror = () => reject("Image load failed");
      img.src = e.target.result;
    };
    reader.onerror = () => reject("FileReader failed");
    reader.readAsDataURL(file);
  });
}

function formatVesselName(raw) {
  if (!raw) return "";
  let clean = raw.replace(/_/g, " ").replace(/\s+/g, " ").trim();
  let firstThree = clean.slice(0,3).toUpperCase();
  let rest = clean.slice(3).trim();
  if (!rest) return firstThree;
  let words = rest.split(" ").map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase());
  let formattedRest = words.join("");
  return firstThree + "_" + formattedRest;
}

function formatAntennaModel(model, sn) {
  if (!model || !sn) return "";
  let m = model.trim().replace(/\s+/g, "-");
  return (m.charAt(0).toUpperCase() + m.slice(1)) + "_SN" + sn.trim().toUpperCase();
}

function formatAntennaLocation(loc) {
  if (!loc) return "";
  return loc.trim().toUpperCase();
}

function formatSubmittedby(name) {
  if (!name) return "";
  return name
    .trim()
    .split(/\s+/)
    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
    .join(" ");
}

let jobFileHandle = null;

document.getElementById("jobInfoLabel").addEventListener("click", async () => {
  try {
    if (window.showOpenFilePicker) {
      if (!jobFileHandle) {
        [jobFileHandle] = await window.showOpenFilePicker({
          types: [{
            description: 'Job Info File',
            accept: { 'text/plain': ['.txt'] },
          }],
          multiple: false
        });
      }
      const file = await jobFileHandle.getFile();
      const text = await file.text();
      const data = JSON.parse(text);
      populateJobInfo(data);
    } else {
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = '.txt';
      fileInput.onchange = async () => {
        if (!fileInput.files || fileInput.files.length === 0) return;
        const file = fileInput.files[0];
        const text = await file.text();
        const data = JSON.parse(text);
        populateJobInfo(data);
      };
      fileInput.click();
    }
  } catch (err) {
    console.error(err);
    statusMessage.textContent = "Failed to load job info or permission denied.";
  }
});

function populateJobInfo(data) {
  if (data.VESSEL) document.getElementById("vesselName").value = formatVesselName(data.VESSEL);
  if (data.INCIDENT) document.getElementById("caseNumber").value = data.INCIDENT;
  if (data["ANTENNA"] && data["ANTENNA SN"]) {
    document.getElementById("antennaModel").value = formatAntennaModel(data["ANTENNA"], data["ANTENNA SN"]);
  }
  if (data["LOCATION"]) document.getElementById("antennaLocation").value = formatAntennaLocation(data["LOCATION"]);
  if (data["TECH"]) document.getElementById("submittedBy").value = formatSubmittedby(data["TECH"]);
  statusMessage.textContent = "Current Job Info loaded successfully!";
}

dropZone.addEventListener('click', () => {
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.multiple = true;
  fileInput.accept = 'image/*';
  fileInput.onchange = () => addImages(fileInput.files);
  fileInput.click();
});
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.style.backgroundColor = "#cce0ff"; });
dropZone.addEventListener('dragleave', e => { e.preventDefault(); dropZone.style.backgroundColor = "#e6f0ff"; });
dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.style.backgroundColor = "#e6f0ff"; addImages(e.dataTransfer.files); });

async function addImages(fileList) {
  if (fileList.length > 0) imageListContainer.style.display = 'flex';
  for (const file of fileList) {
    if (file.type.startsWith('image/')) {
      const thumbDataUrl = await fileToJpegDataURL(file, 400, 0.6);
      const wrapper = document.createElement('div');
      wrapper.classList.add('image-wrapper');
      const previewImg = document.createElement('img');
      previewImg.src = thumbDataUrl;
      previewImg.classList.add('image-item');
      const removeBtn = document.createElement('button');
      removeBtn.innerHTML = "√ó";
      removeBtn.classList.add('remove-image-btn');
      removeBtn.onclick = () => {
        const index = Array.from(imageListContainer.children).indexOf(wrapper);
        if (index > -1) images.splice(index, 1);
        wrapper.remove();
        if (images.length === 0) imageListContainer.style.display = 'none';
      };
      wrapper.appendChild(previewImg);
      wrapper.appendChild(removeBtn);
      imageListContainer.appendChild(wrapper);
      images.push(file);
    }
  }
}

document.getElementById('removeAllBtn').addEventListener('click', () => {
  images = [];
  imageListContainer.innerHTML = '';
  imageListContainer.style.display = 'none';
  statusMessage.textContent = 'All images removed.';
});

attachmentsDropZone.addEventListener('click', () => {
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.multiple = true;
  fileInput.onchange = () => addAttachments(fileInput.files);
  fileInput.click();
});
attachmentsDropZone.addEventListener('dragover', e => { e.preventDefault(); attachmentsDropZone.style.backgroundColor = "#cce0ff"; });
attachmentsDropZone.addEventListener('dragleave', e => { e.preventDefault(); attachmentsDropZone.style.backgroundColor = "#e6f0ff"; });
attachmentsDropZone.addEventListener('drop', e => { e.preventDefault(); attachmentsDropZone.style.backgroundColor = "#e6f0ff"; addAttachments(e.dataTransfer.files); });

function addAttachments(fileList){
  if(fileList.length > 0) attachmentListContainer.style.display = 'block';
  Array.from(fileList).forEach(file => {
    attachments.push(file);
    const item = document.createElement('div');
    item.textContent = file.name;
    item.classList.add('attachment-item');
    attachmentListContainer.appendChild(item);
  });
}
document.getElementById('removeAllAttachmentsBtn').addEventListener('click', () => {
  attachments = [];
  attachmentListContainer.innerHTML = '';
  attachmentListContainer.style.display = 'none';
  statusMessage.textContent = 'All attachments removed.';
});


generateBtn.addEventListener('click', async () => {
  statusMessage.textContent = '';
  generateBtn.disabled = true;

  try {
    const requiredIds = ["vesselName", "antennaModel", "antennaLocation", "caseNumber", "submittedBy", "dateField"];
    let valid = true;
    requiredIds.forEach(id => {
      const f = document.getElementById(id);
      if (!f.value.trim()) {
        f.classList.add("invalid");
        valid = false;
      } else {
        f.classList.remove("invalid");
      }
    });
    if (!valid) throw new Error("Please fill all required fields!");

    if (images.length === 0 && attachments.length === 0) throw new Error("Add at least one image or attachment.");

    statusMessage.textContent = "Generating PDF and output files...";

    // Use raw vessel name as requested
    const vessel = document.getElementById('vesselName').value.trim();
    const antenna = document.getElementById('antennaModel').value.trim();
    const location = document.getElementById('antennaLocation').value.trim().toUpperCase();
    const caseNum = document.getElementById('caseNumber').value.trim();
    const submitted = formatSubmittedby(document.getElementById('submittedBy').value.trim());
    const dateStr = document.getElementById('dateField').value;
    const perPage = parseInt(document.getElementById('imagesPerPage').value);

    const pdf = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    const logoUrl = 'https://raw.githubusercontent.com/pgarciafer/pics2PDF/main/logo.png';
    const logo = await loadImage(logoUrl);
    if (logo) {
      const logoWidth = 350;
      const logoHeight = (logo.height * logoWidth) / logo.width;
      pdf.addImage(logo, 'PNG', (pageWidth - logoWidth) / 2, 50, logoWidth, logoHeight);
    }

    pdf.setFontSize(26).setFont('helvetica', 'bold');
    pdf.text(vessel, pageWidth / 2, 250, { align: 'center' });
    pdf.setFontSize(18);
    pdf.text(`${antenna} (${location})`, pageWidth / 2, 290, { align: 'center' });
    pdf.setFontSize(14);
    pdf.text(`Case Number: ${caseNum}`, pageWidth / 2, 330, { align: 'center' });
    pdf.text(`Submitted By: ${submitted}`, pageWidth / 2, 360, { align: 'center' });
    pdf.text(`Date: ${dateStr}`, pageWidth / 2, 385, { align: 'center' });

    if (images.length > 0) {
      pdf.addPage();
      let pageNum = 2;
      for (let i = 0; i < images.length; i += perPage) {
        const chunk = images.slice(i, i + perPage);
        let spacingX = 10, spacingY = 10;
        let cellWidth = (pageWidth - (perPage + 1) * spacingX) / perPage;
        let cellHeight = pageHeight - 2 * spacingY;
        for (let idx = 0; idx < chunk.length; idx++) {
          await addImageToPDF(pdf, chunk[idx], spacingX + idx * (cellWidth + spacingX), spacingY, cellWidth, cellHeight);
        }
        pdf.setFontSize(12).text(`Page ${pageNum}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
        if (i + perPage < images.length) pdf.addPage();
        pageNum++;
      }
    }

    if (attachments.length > 0) {
      pdf.addPage();
      pdf.setFontSize(16).setFont('helvetica', 'bold');
      pdf.text("Attached Files", pageWidth / 2, 30, { align: 'center' });
      pdf.setFontSize(12).setFont('helvetica', 'normal');
      let startY = 60;
      for (const att of attachments) {
        pdf.text(`üìé ${att.name}`, 20, startY);
        startY += 25;
        if (startY > pageHeight - 40) {
          pdf.addPage();
          startY = 40;
        }
      }
    }

    const pdfFilename = `${vessel}_PicArray_${antenna}_${location.replace(/ /g, '')}_Case${caseNum}_${dateStr.replace(/-/g,'')}.pdf`;
    
    // --- START MODIFIED LOGIC ---
    if (attachments.length > 0) {
      // Generate ZIP if there are attachments
      const zip = new JSZip();
      const pdfBlob = new Blob([pdf.output('blob')], { type: 'application/pdf' });
      zip.file(pdfFilename, pdfBlob);

      const attachmentsFolder = zip.folder("attachments");
      for (const att of attachments) {
        attachmentsFolder.file(att.name, att);
      }

      const zipFilename = pdfFilename.replace('.pdf', '.zip');
      zip.generateAsync({ type: "blob" }).then(content => {
        saveAs(content, zipFilename);
        statusMessage.textContent = 'PDF and ZIP generated successfully!';
      });
    } else {
      // Just save the PDF if there are no attachments
      const pdfBlob = pdf.output('blob');
      saveAs(pdfBlob, pdfFilename);
      statusMessage.textContent = 'PDF generated successfully!';
    }
    // --- END MODIFIED LOGIC ---

  } catch (err) {
    statusMessage.textContent = err.message || "Error generating PDF/ZIP.";
    console.error(err);
  } finally {
    generateBtn.disabled = false;
  }
});


function loadImage(src){
  return new Promise(res=>{
    const img=new Image();
    img.crossOrigin='Anonymous';
    img.src=src;
    img.onload=()=>res(img);
    img.onerror=()=>res(null);
  });
}

async function addImageToPDF(pdf, file, x, y, width, height) {
  const dataUrl = await fileToJpegDataURL(file, 2000, 0.7);
  if (!dataUrl) return;
  const img = new Image();
  img.src = dataUrl;
  await new Promise(res => { img.onload = res; });
  const cellAspect = width / height;
  const imgAspect = img.width / img.height;
  let finalW, finalH;
  if (imgAspect > cellAspect) {
    finalW = width * 0.95;
    finalH = finalW / imgAspect;
  } else {
    finalH = height * 0.95;
    finalW = finalH * imgAspect;
  }
  pdf.addImage(
    dataUrl,
    "JPEG",
    x + (width - finalW) / 2,
    y + (height - finalH) / 2,
    finalW,
    finalH
  );
}
</script>
</body>
</html>

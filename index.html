<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pictures to PDF Generator</title>
<link rel="icon" href="https://raw.githubusercontent.com/pgarciafer/pics2PDF/main/logo1.png" type="image/png">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --primary-blue: #0069d9;
    --dark-blue: #004c99;
    --light-gray: #f8f9fa;
    --medium-gray: #e9ecef;
    --dark-text: #343a40;
    --red-error: #dc3545;
  }
  body {
    font-family: 'Poppins', sans-serif;
    background-color: var(--light-gray);
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
  }
  .container {
    max-width: 700px;
    width: 95%;
    margin: 10px;
    padding: 15px;
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
  }
  .header-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    border-bottom: 3px solid var(--medium-gray);
    padding-bottom: 15px;
  }
  .header-title {
    display: flex;
    align-items: center;
  }
  .header-title img {
    height: 60px;
    vertical-align: middle;
    margin-right: 15px;
  }
  .header-title span {
    color: var(--dark-text);
    font-size: 20px;
    font-weight: 600;
  }
  .contact-btn {
    padding: 8px 12px;
    background-color: var(--primary-blue);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    text-decoration: none;
    transition: background-color 0.3s;
  }
  .contact-btn:hover {
    background-color: var(--dark-blue);
  }
  label {
    display: block;
    margin-top: 10px;
    font-weight: 600;
    color: var(--dark-text);
    font-size: 13px;
  }
  input, select, textarea {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    border-radius: 6px;
    border: 1px solid var(--medium-gray);
    font-size: 13px;
    box-sizing: border-box;
    transition: border-color 0.3s, box-shadow 0.3s;
  }
  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 2px rgba(0, 105, 217, 0.25);
  }
  input[type="file"] {
    padding: 8px;
  }
  .drop-zone {
    border: 3px dashed var(--primary-blue);
    background: #e6f0ff;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    margin-bottom: 15px;
    border-radius: 8px;
    transition: background 0.3s, border-color 0.3s;
  }
  .drop-zone:hover {
    background: #cce0ff;
    border-color: var(--dark-blue);
  }
  .drop-zone p {
    font-size: 14px;
    color: var(--dark-blue);
    margin: 0;
  }
  .image-list-container {
    border: 1px solid var(--medium-gray);
    min-height: 100px;
    max-height: 150px;
    overflow-y: auto;
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 6px;
    background: #fafafa;
    display: none;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: flex-start;
  }
  .image-item {
    width: 50px;
    height: 50px;
    object-fit: contain;
    border: 1px solid var(--medium-gray);
    border-radius: 6px;
    padding: 5px;
    background: #fff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  .attachment-list-container {
    border: 1px solid var(--medium-gray);
    min-height: 50px;
    max-height: 100px;
    overflow-y: auto;
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 6px;
    background: #fafafa;
    display: none;
  }
  .attachment-item {
    font-size: 12px;
    color: var(--dark-text);
    padding: 5px 0;
    border-bottom: 1px solid var(--medium-gray);
  }
  .attachment-item:last-child {
    border-bottom: none;
  }
  .button-group {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 15px;
  }
  button {
    flex: 1;
    padding: 10px 15px;
    background-color: var(--primary-blue);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: background-color 0.3s, transform 0.1s;
  }
  button:hover {
    background-color: var(--dark-blue);
  }
  button:disabled {
    background-color: #ced4da;
    cursor: not-allowed;
  }
  .required-label {
    color: var(--red-error);
  }
  .required {
    border: 2px solid var(--red-error) !important;
  }
  .status-message {
    text-align: center;
    margin-top: 10px;
    font-size: 12px;
    color: var(--dark-text);
  }
  @media (max-width: 600px) {
    .container {
      padding: 15px;
      margin: 10px;
    }
    .header-container {
      flex-direction: column;
      align-items: center;
    }
    .header-title {
      flex-direction: column;
      margin-bottom: 10px;
    }
    .contact-btn {
      width: 100%;
      text-align: center;
    }
    .button-group button {
      flex: 1 1 100%;
    }
  }
</style>
</head>
<body>
<div class="container">
<div class="header-container">
  <div class="header-title">
    <img src="https://raw.githubusercontent.com/pgarciafer/pics2PDF/main/logo.png" alt="Logo">
    <span>Pictures Array to PDF</span>
  </div>
  <a href="contact.html" class="contact-btn">Contact</a>
</div>

<div class="drop-zone" id="dropZone">
  <p>üìÅ Drag & Drop Images Here or Click to Select</p>
</div>

<div class="image-list-container" id="imageListContainer"></div>
<div class="button-group">
  <button id="removeAllBtn">Remove All Images</button>
</div>

<div class="drop-zone" id="attachmentsDropZone">
  <p>üìé Drag & Drop Attachments Here or Click to Select</p>
</div>

<div class="attachment-list-container" id="attachmentListContainer"></div>
<div class="button-group">
  <button id="removeAllAttachmentsBtn">Remove All Attachments</button>
</div>

<label for="vesselName">3LC_VesselName: <span class="required-label">*</span></label>
<input type="text" id="vesselName" class="required" placeholder="e.g., NCL_RoyalClipper">

<label for="antennaModel">AntennaBrandModel_SNxxx: <span class="required-label">*</span></label>
<input type="text" id="antennaModel" class="required" placeholder="e.g., Intellian-v100_SN24536">

<label for="antennaLocation">Antenna Location: <span class="required-label">*</span></label>
<input type="text" id="antennaLocation" class="required" placeholder="e.g., Deck 1 Starboard">

<label for="caseNumber">Case Number: <span class="required-label">*</span></label>
<input type="text" id="caseNumber" class="required" placeholder="e.g., 35234">

<label for="submittedBy">Submitted By: <span class="required-label">*</span></label>
<input type="text" id="submittedBy" class="required" placeholder="e.g., Pablo Garcia">

<label for="dateField">Date: <span class="required-label">*</span></label>
<input type="date" id="dateField" class="required">

<label for="imagesPerPage">Images per page (1-4):</label>
<select id="imagesPerPage">
  <option value="1">1</option>
  <option value="2" selected>2</option>
  <option value="3">3</option>
  <option value="4">4</option>
</select>

<div class="button-group">
  <button id="generatePDF">Generate PDF</button>
</div>

<div class="status-message" id="statusMessage"></div>

</div>

<script>
const { jsPDF } = window.jspdf;
let images = [];
let attachments = [];
const dropZone = document.getElementById('dropZone');
const imageListContainer = document.getElementById('imageListContainer');
const attachmentsDropZone = document.getElementById('attachmentsDropZone');
const attachmentListContainer = document.getElementById('attachmentListContainer');
const generateBtn = document.getElementById('generatePDF');
const statusMessage = document.getElementById('statusMessage');

// Default date to today
document.getElementById('dateField').valueAsDate = new Date();

// Drag & Drop for Images
dropZone.addEventListener('click', () => {
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.multiple = true;
  fileInput.accept = 'image/*';
  fileInput.onchange = () => addImages(fileInput.files);
  fileInput.click();
});

dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.style.backgroundColor = "#cce0ff"; });
dropZone.addEventListener('dragleave', e => { e.preventDefault(); dropZone.style.backgroundColor = "#e6f0ff"; });
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.style.backgroundColor = "#e6f0ff";
  addImages(e.dataTransfer.files);
});

function addImages(fileList){
  if(fileList.length > 0) {
    imageListContainer.style.display = 'flex';
  }
  Array.from(fileList).forEach(file => {
    if(file.type.startsWith('image/')){
      images.push(file);
      const img = document.createElement('img');
      img.src = URL.createObjectURL(file);
      img.classList.add('image-item');
      imageListContainer.appendChild(img);
    }
  });
}

// Remove all images
document.getElementById('removeAllBtn').addEventListener('click', () => {
  images = [];
  imageListContainer.innerHTML = '';
  imageListContainer.style.display = 'none';
  statusMessage.textContent = 'All images removed.';
});

// Drag & Drop for Attachments
attachmentsDropZone.addEventListener('click', () => {
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.multiple = true;
  fileInput.onchange = () => addAttachments(fileInput.files);
  fileInput.click();
});

attachmentsDropZone.addEventListener('dragover', e => { e.preventDefault(); attachmentsDropZone.style.backgroundColor = "#cce0ff"; });
attachmentsDropZone.addEventListener('dragleave', e => { e.preventDefault(); attachmentsDropZone.style.backgroundColor = "#e6f0ff"; });
attachmentsDropZone.addEventListener('drop', e => {
  e.preventDefault();
  attachmentsDropZone.style.backgroundColor = "#e6f0ff";
  addAttachments(e.dataTransfer.files);
});

function addAttachments(fileList){
  if(fileList.length > 0) {
    attachmentListContainer.style.display = 'block';
  }
  Array.from(fileList).forEach(file => {
    attachments.push(file);
    const item = document.createElement('div');
    item.textContent = file.name;
    item.classList.add('attachment-item');
    attachmentListContainer.appendChild(item);
  });
}

// Remove all attachments
document.getElementById('removeAllAttachmentsBtn').addEventListener('click', () => {
  attachments = [];
  attachmentListContainer.innerHTML = '';
  attachmentListContainer.style.display = 'none';
  statusMessage.textContent = 'All attachments removed.';
});

// PDF generation
generateBtn.addEventListener('click', async () => {
  statusMessage.textContent = '';
  generateBtn.disabled = true;

  const requiredFields = document.querySelectorAll('.required');
  let valid = true;
  requiredFields.forEach(f => {
    if(!f.value.trim()){
      f.classList.add("required");
      valid = false;
    } else { f.classList.remove("required"); }
  });

  if(!valid) {
    statusMessage.textContent = "Please fill all required fields!";
    generateBtn.disabled = false;
    return;
  }
  if(images.length === 0 && attachments.length === 0){
    statusMessage.textContent = "Add at least one image or attachment.";
    generateBtn.disabled = false;
    return;
  }

  statusMessage.textContent = "Generating PDF... Please wait.";

  const vessel = document.getElementById('vesselName').value.trim();
  const antenna = document.getElementById('antennaModel').value.trim();
  const location = document.getElementById('antennaLocation').value.trim();
  const caseNum = document.getElementById('caseNumber').value.trim();
  const submitted = document.getElementById('submittedBy').value.trim();
  const dateStr = document.getElementById('dateField').value;
  const perPage = parseInt(document.getElementById('imagesPerPage').value);

  const pdf = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();

  // Cover page - Logo
  const logoUrl = 'https://raw.githubusercontent.com/pgarciafer/pics2PDF/main/logo.png';
  const logo = new Image();
  logo.crossOrigin = 'Anonymous';
  logo.src = logoUrl;

  await new Promise((resolve, reject) => {
    logo.onload = () => {
      const logoWidth = 350;
      const logoHeight = (logo.height * logoWidth) / logo.width;
      const logoX = (pageWidth - logoWidth) / 2;
      const logoY = 50;
      pdf.addImage(logo, 'PNG', logoX, logoY, logoWidth, logoHeight);
      resolve();
    };
    logo.onerror = () => {
      console.error('Failed to load logo from URL');
      resolve();
    };
  });

  // Cover page - Text content
  pdf.setFontSize(26);
  pdf.setFont('helvetica', 'bold');
  pdf.text(vessel, pageWidth/2, 250, { align: 'center' });
  pdf.setFontSize(22);
  pdf.text(`${antenna} (${location})`, pageWidth/2, 290, { align: 'center' });
  pdf.setFontSize(18);
  pdf.text(`Case Number: ${caseNum}`, pageWidth/2, 330, { align: 'center' });
  pdf.setFontSize(14);
  pdf.text(`Submitted By: ${submitted}`, pageWidth/2, 360, { align: 'center' });
  pdf.text(`Date: ${dateStr}`, pageWidth/2, 385, { align: 'center' });
  
  if (images.length > 0 || attachments.length > 0) {
      pdf.addPage();
  }

  let pageNum = 2;
  for(let i=0;i<images.length;i+=perPage){
    const chunk = images.slice(i, i+perPage);
    const spacingX = 10, spacingY = 10;
    let cellWidth, cellHeight;

    if(perPage===1){
      cellWidth = pageWidth - 2 * spacingX;
      cellHeight = pageHeight - 2 * spacingY;
      await addImageToPDF(pdf, chunk[0], spacingX, spacingY, cellWidth, cellHeight);
    } else if(perPage===4){
      cellWidth = (pageWidth - 3 * spacingX) / 2;
      cellHeight = (pageHeight - 3 * spacingY) / 2;
      for(let idx=0; idx < chunk.length; idx++){
        let row = Math.floor(idx/2);
        let col = idx % 2;
        let x = spacingX + col * (cellWidth + spacingX);
        let y = spacingY + row * (cellHeight + spacingY);
        await addImageToPDF(pdf, chunk[idx], x, y, cellWidth, cellHeight);
      }
    } else {
      cellWidth = (pageWidth - spacingX * (perPage + 1)) / perPage;
      cellHeight = pageHeight - 2 * spacingY;
      for(let idx = 0; idx < chunk.length; idx++){
        let x = spacingX + idx * (cellWidth + spacingX);
        let y = spacingY;
        await addImageToPDF(pdf, chunk[idx], x, y, cellWidth, cellHeight);
      }
    }

    pdf.setFontSize(12);
    pdf.text(`Page ${pageNum}`, pageWidth/2, pageHeight-10, { align: 'center' });
    if(i + perPage < images.length) pdf.addPage();
    pageNum++;
  }

  // Add attachments page
  if (attachments.length > 0) {
      if (images.length > 0) {
          pdf.addPage();
      }
      await addAttachmentsToPDF(pdf, attachments);
      pdf.setFontSize(12);
      pdf.text(`Page ${pageNum}`, pageWidth/2, pageHeight-10, { align: 'center' });
  }

  pdf.save(`${vessel}_PictureArray.pdf`);
  statusMessage.textContent = 'PDF generated successfully!';
  generateBtn.disabled = false;
});

// Helpers
function fileToDataURL(file){
  return new Promise(res => {
    const reader = new FileReader();
    reader.onload = () => res(reader.result);
    reader.readAsDataURL(file);
  });
}

function loadImage(src){
  return new Promise(res => {
    const img = new Image();
    img.crossOrigin = 'Anonymous';
    img.src = src;
    img.onload = () => res(img);
    img.onerror = () => {
        console.error("Failed to load image from URL:", src);
        res(null);
    };
  });
}

async function addImageToPDF(pdf, file, x, y, width, height){
  let src;
  if(file instanceof File) {
      src = await fileToDataURL(file);
  } else {
      src = file;
  }
  
  const img = await loadImage(src);
  if (!img) return;

  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');

  // Downscale image to a reasonable size before compressing
  let maxDim = 1000;
  let scale = Math.min(maxDim / img.width, maxDim / img.height, 1);
  canvas.width = img.width * scale;
  canvas.height = img.height * scale;
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

  const compressed = canvas.toDataURL('image/jpeg', 0.7);

  const cellAspect = width / height;
  const imgAspect = img.width / img.height;
  let finalWidth, finalHeight;

  if (imgAspect > cellAspect) {
    finalWidth = width * 0.95;
    finalHeight = finalWidth / imgAspect;
  } else {
    finalHeight = height * 0.95;
    finalWidth = finalHeight * imgAspect;
  }

  const xOffset = x + (width - finalWidth) / 2;
  const yOffset = y + (height - finalHeight) / 2;

  pdf.addImage(compressed, 'JPEG', xOffset, yOffset, finalWidth, finalHeight);
}

// New function to add attachments to the PDF
async function addAttachmentsToPDF(pdf, attachments) {
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const iconSize = 40;
    const padding = 20;
    const startX = padding;
    let startY = 40;

    pdf.setFontSize(20);
    pdf.setFont('helvetica', 'bold');
    pdf.text("Attached Files", pageWidth/2, 30, { align: 'center' });
    startY += 20;

    pdf.setFontSize(10);
    pdf.setFont('helvetica', 'normal');

    for (const attachment of attachments) {
        // Embed the file
        const data = await fileToDataURL(attachment);
        pdf.addFileToDoc({
            fileName: attachment.name,
            fileData: data,
            mimeType: attachment.type,
            description: "Attached file"
        });

        // Add an icon and filename to the page
        const fileIconURL = 'https://raw.githubusercontent.com/pgarciafer/pics2PDF/main/file-icon.png';
        const fileIcon = await loadImage(fileIconURL);

        if (fileIcon) {
            pdf.addImage(fileIcon, 'PNG', startX, startY, iconSize, iconSize);
            pdf.text(attachment.name, startX + iconSize + 10, startY + (iconSize / 2), { baseline: 'middle' });
        } else {
            pdf.text(`üìé ${attachment.name}`, startX, startY + (iconSize / 2), { baseline: 'middle' });
        }

        startY += iconSize + 10;
        if (startY > pageHeight - padding) {
            pdf.addPage();
            startY = padding;
        }
    }
}
</script>
</body>
</html>
